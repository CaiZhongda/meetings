$("body").bind("click",function(){$(".dropdown-toggle, .menu").parent("li").removeClass("open")});$(".dropdown-toggle, .menu").click(function(){$(this).parent("li").toggleClass("open");return!1});function getCookie(d){return(d=document.cookie.match("\\b"+d+"=([^;]*)\\b"))?d[1]:void 0}
(function(){$(document.body).hasClass("home")&&($.ajaxSetup({data:{_xsrf:getCookie("_xsrf")}}),$("tr.room").delegate("a.danger","click",function(d){d.preventDefault();var f=$(this);confirm("Are you sure to delete this room? All the messages and files in this room will also be deleted")&&$.post("/rooms/"+f.data("room")+"/delete",function(){f.parents("tr.room").fadeOut()})}))})();
(function(){function d(){for(var a=arguments[0]||"",b=1;b<arguments.length;b++)a=a.replace(RegExp("\\{"+(b-1)+"}","gim"),arguments[b]);return a}function f(a){var b=".bmp,.gif,.jpg,.jpeg,.png,.tif".split(","),c=a.match(/(https?:\/\/.*(?=&quot;|&#39;))|[^\s\t]{0}(http:\/\/[^\s\t]*)/);if(c!==null&&c!==void 0){for(var i=[],e=0;e<c.length;e++)c[e]!==void 0&&c[e]!==null&&i.indexOf(c[e])===-1&&i.push(c[e]);for(e=0;e<i.length;e++)var c=i[e],f=c.match(/\.[^\.]+$/),a=f!==void 0&&f!==null&&b.indexOf(f[0])!==
-1?a.replace(c,d('<a href="{0}" target="_blank"><img src="{0}" class="thumbnail" alt="{0}"></a>',c)):c.match(/youtube\.com\/(v|watch)/)?a.replace(c,m(c)):a.replace(c,d("<a href='{0}' target='_blank'>{0}</a>",c))}return a}function m(a){var b=a.match(/youtube\.com\/watch\?v=([a-zA-Z0-9\-_]+)/);b&&(a="http://www.youtube.com/v/"+b[1]);return d('<object width="{0}" height="{1}"><param name="movie" value="{2}?fs=1"</param><param name="allowFullScreen" value="true"></param><param name="wmode" value="transparent"><embed src="{2}?fs=1" type="application/x-shockwave-flash" allowfullscreen="true" width="{0}" height="{1}" wmode="transparent"></embed></object>',
300,200,a)}if(window.M){$("#room-menu a").removeClass("active");$("#room-menu a."+M.active_menu).addClass("active");var k=$("#new_message"),g=k.find("textarea"),j=function(a){var b=$("<tr>");b.append($("<td>").addClass("user").text(a.user_name));var c=$("<td>");if(a.type=="image"){var d=$("<a>").attr({href:a.url,target:"_blank"});d.append($("<img>").attr("src",a.thumb_url));c.append(d)}else a.type=="file"?c.append($("<a>").attr({href:a.url,target:"_blank"}).text(a.url)):a.type=="text"?c.text(a.content):
a.type=="topic_changed"&&c.text("changed topic to "+a.content);b.append(c);$("#no-messages").fadeOut("slow");return b};PUBNUB.subscribe({channel:M.room.token,error:function(){},callback:function(a){if(a.type=="image"||a.type=="file")$("#messages").append(j(a)),h();a.type=="text"&&a.user_id!==M.current_user.id&&($("#messages").append(j(a)),h());if(a.type=="presence"&&a.user_id!==M.current_user.id){var b="user_"+a.user_id;$("#"+b).length===0&&(b=$("<li>").attr("id",b).text(a.user_name),$("#room-users").append(b))}a.type==
"leave"&&$("#user_"+a.user_id).fadeOut("slow").remove();a.type==="topic_changed"&&($("#topic").text(a.content),$("#messages").append(j(a)))},connect:function(){}});k.submit(function(a){var b=$(this),c=b.attr("action");$("#messages").append(j({user_name:M.current_user.name,content:g.val(),type:"text"}));h();$.post(c,b.serialize(),function(){});b[0].reset();a.preventDefault()});g.keypress(function(a){if((a.keyCode?a.keyCode:a.which)===13)a.preventDefault(),uploader.total.queued>0?(uploader.start(),
$(this).val("")):$(this).val()!==""&&k.submit()});var h=function(){$("html, body").animate({scrollTop:$(document).height()},"slow")};$("#messages").find("tr.text td").each(function(a,b){b.innerHTML=f(b.innerHTML)});g.focus();setTimeout(h,50);var l=function(a){return(a=document.cookie.match("\\b"+a+"=([^;]*)\\b"))?a[1]:void 0};window.uploader=new plupload.Uploader({runtimes:"html5,flash",browse_button:"select_files",container:"upload_container",max_file_size:"10mb",url:"/rooms/"+M.room.id+"/upload",
flash_swf_url:"/static/javascripts/plupload.flash.swf",filters:[],multipart:!0,multipart_params:{_xsrf:l("_xsrf"),auth_token:l("auth_token")},drop_element:"text_content"});uploader.bind("Init",function(){});uploader.bind("FilesAdded",function(a,b){var c=$("#text_content").val();$.each(b,function(a,b){c+=b.name+" "+plupload.formatSize(b.size)+"\n"});$("#text_content").val(c);a.refresh();$("#upload_buttons").show();$("#upload").show()});uploader.bind("UploadProgress",function(a,b){$("#"+b.id+" b").html(b.percent+
"%")});uploader.bind("Error",function(a,b){$("#filelist").append("<div>Error: "+b.code+", Message: "+b.message+(b.file?", File: "+b.file.name:"")+"</div>");a.refresh()});uploader.bind("FileUploaded",function(){$("#upload").text("Upload files").removeClass("disabled").hide()});$("#upload").click(function(a){uploader.start();g.val("");$(this).text("Uploading...").addClass("disabled");a.preventDefault()});uploader.init();$("#room-menu a").pjax("#content").live("click",function(){$("#room-menu a").removeClass("active");
$(this).addClass("active")});$(document.body).bind("end.pjax",function(){$("#messages").find("tr.text td").each(function(a,b){b.innerHTML=f(b.innerHTML)});g.focus();$("#messages").length>0&&setTimeout(h,50)})}})();